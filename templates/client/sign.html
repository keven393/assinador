<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinatura - Assinador Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative; /* Garante que o body seja o stacking context base */
            overflow-x: hidden; /* Previne scroll horizontal indesejado */
        }
        .client-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 2rem auto;
            max-width: 700px;
            overflow: hidden;
            z-index: 1;
        }
        
        .container {
            position: relative; /* IMPORTANTE: Permite posicionamento absolute do dialog em relação ao container */
        }
        .client-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .client-body {
            padding: 2rem;
        }
        .document-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #28a745;
        }
        .signature-area {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px dashed #dee2e6;
        }
        .canvas-container {
            position: relative;
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #signatureCanvas {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: crosshair;
            background: white;
            touch-action: none;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            /* Enhanced touch compatibility */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Samsung Internet compatibility */
            -webkit-tap-highlight-color: transparent;
            /* Better touch responsiveness */
            position: relative;
            z-index: 1;
        }
        
        /* Enhanced mobile and tablet optimizations */
        @media (max-width: 768px) {
            #signatureCanvas {
                width: 100% !important;
                max-width: 100%;
                height: 200px;
            }
            .client-container {
                margin: 1rem;
                max-width: 100%;
            }
            .btn-client {
                font-size: 1rem;
                padding: 0.6rem 1.5rem;
            }
            .btn-group-signature {
                flex-direction: column;
                align-items: center;
            }
            .btn-group-signature .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Tablet specific optimizations */
        @media (min-width: 769px) and (max-width: 1024px) {
            #signatureCanvas {
                width: 100% !important;
                max-width: 100%;
                height: 250px;
            }
            
            .btn-group-signature {
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .btn-group-signature .btn {
                flex: 1;
                min-width: 150px;
                margin: 0.25rem;
            }
        }
        
         /* Signature Dialog - CENTRALIZADO NA TELA (VIEWPORT) */
         .signature-dialog {
             position: fixed !important; /* Fixed em relação ao viewport */
             top: 0 !important;
             left: 0 !important;
             width: 100vw !important; /* Cobre toda a largura da viewport */
             height: 100vh !important; /* Cobre toda a altura da viewport */
             z-index: 999999 !important; /* Alto para ficar acima de tudo */
             display: flex !important; /* Sempre flex para permitir animação */
             align-items: center !important; /* Centraliza verticalmente */
             justify-content: center !important; /* Centraliza horizontalmente */
             opacity: 0;
             transform: scale(0.8) translateY(30px);
             transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
             visibility: hidden; /* Usa visibility para esconder */
             /* Animação suave com bounce effect */
         }
         
         .signature-dialog::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.5);
             opacity: 0;
             transition: opacity 0.3s ease;
         }
         
         .signature-dialog.active::before {
             opacity: 1;
         }
         
         .signature-dialog.active {
             opacity: 1 !important;
             transform: scale(1) translateY(0) !important;
             visibility: visible !important; /* Mostra o dialog */
         }
         
         /* Previne scroll do body quando dialog está aberto */
         body.dialog-open {
             overflow: hidden !important;
         }
         
         .dialog-content {
             background: white !important;
             border-radius: 16px !important;
             box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
             width: 100% !important;
             max-width: 90vw !important; /* 90% da largura da viewport */
             max-height: 90vh !important; /* 90% da altura da viewport */
             display: flex !important;
             flex-direction: column !important;
             overflow: hidden !important;
             transform: translateY(40px) scale(0.9) !important;
             transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
             position: relative !important;
             z-index: 1000000 !important; /* Acima do backdrop */
             margin: 0; /* Sem margem - centralização perfeita */
             opacity: 0;
         }
         
         .signature-dialog.active .dialog-content {
             transform: translateY(0) scale(1) !important;
             opacity: 1 !important;
         }
         
         /* Z-index para filhos do dialog (herda do content) */
         .dialog-header,
         .dialog-canvas-container,
         .dialog-controls {
             position: relative;
             z-index: auto;
         }
         
         /* Animações para elementos internos */
         .dialog-header {
             transform: translateY(-20px);
             opacity: 0;
             transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s;
         }
         
         .dialog-canvas-container {
             transform: translateY(20px);
             opacity: 0;
             transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s;
         }
         
         .dialog-controls {
             transform: translateY(20px);
             opacity: 0;
             transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s;
         }
         
         .signature-dialog.active .dialog-header,
         .signature-dialog.active .dialog-canvas-container,
         .signature-dialog.active .dialog-controls {
             transform: translateY(0);
             opacity: 1;
         }
         
         .dialog-header {
             background: linear-gradient(135deg, #28a745, #20c997);
             color: white;
             padding: 1.5rem;
             display: flex;
             justify-content: space-between;
             align-items: center;
             box-shadow: 0 2px 10px rgba(0,0,0,0.1);
             border-radius: 16px 16px 0 0;
         }
         
         .dialog-title {
             margin: 0;
             font-size: 1.3rem;
             font-weight: 600;
             display: flex;
             align-items: center;
             gap: 0.5rem;
         }
         
         .dialog-close {
             background: rgba(255,255,255,0.2);
             border: none;
             color: white;
             border-radius: 50%;
             width: 44px;
             height: 44px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             transition: all 0.3s ease;
             font-size: 1.2rem;
         }
         
         .dialog-close:hover {
             background: rgba(255,255,255,0.3);
             transform: scale(1.1);
         }
         
         .dialog-canvas-container {
                flex: 0 0 auto;        /* não crescer automaticamente */
                padding: 1.5rem;
                display: block;        /* simples: deixa o bloco medir pela altura definida */
                overflow: visible;     /* evita corte do canvas */
                min-height: 0;         /* remove travas de min-height */
            }
         
         .dialog-canvas {
             width: 100%;
             height: 100%;
             min-height: 250px;
             border: 2px solid #dee2e6;
             border-radius: 12px;
             background: white;
             touch-action: none;
             cursor: crosshair;
         }
         
         .dialog-controls {
             background: #f8f9fa;
             padding: 1.5rem;
             border-top: 1px solid #dee2e6;
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 1rem;
             border-radius: 0 0 16px 16px;
         }
         
         .color-picker-group {
             display: flex;
             align-items: center;
             gap: 0.75rem;
         }
         
         .color-picker {
             width: 36px;
             height: 36px;
             border-radius: 50%;
             border: 3px solid transparent;
             cursor: pointer;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         }
         
         .color-picker:hover {
             transform: scale(1.1);
         }
         
         .color-picker.active {
             border-color: #007bff;
             transform: scale(1.2);
             box-shadow: 0 4px 12px rgba(0,123,255,0.3);
         }
         
         .dialog-buttons {
             display: flex;
             gap: 0.75rem;
             flex-wrap: wrap;
         }
         
         .dialog-btn {
             padding: 0.75rem 1.25rem;
             border: none;
             border-radius: 8px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             display: flex;
             align-items: center;
             gap: 0.5rem;
             font-size: 0.9rem;
             min-width: 100px;
         }
         
         .dialog-btn-clear {
             background: #dc3545;
             color: white;
         }
         
         .dialog-btn-clear:hover {
             background: #c82333;
         }
         
         .dialog-btn-undo {
             background: #6c757d;
             color: white;
         }
         
         .dialog-btn-undo:hover {
             background: #5a6268;
         }
         
         .dialog-btn-done {
             background: #28a745;
             color: white;
         }
         
         .dialog-btn-done:hover {
             background: #218838;
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(40,167,69,0.3);
         }
         
         /* Responsive - Ajustado para viewport */
         @media (max-width: 480px) {
             .dialog-content {
                 max-width: 95vw !important;
                 max-height: 95vh !important;
                 margin: 0 !important;
             }
             
             .dialog-header {
                 padding: 1rem;
             }
             
             .dialog-title {
                 font-size: 1.1rem;
             }
             
             .dialog-canvas-container {
                 padding: 1rem;
                 min-height: 250px;
             }
             
             .dialog-canvas {
                 min-height: 200px;
             }
             
             .dialog-controls {
                 padding: 1rem;
                 flex-direction: column;
                 gap: 1rem;
             }
             
             .color-picker-group {
                 justify-content: center;
             }
             
             .dialog-buttons {
                 justify-content: center;
                 width: 100%;
             }
             
             .dialog-btn {
                 flex: 1;
                 min-width: 80px;
                 padding: 0.6rem 1rem;
             }
         }
         
         @media (min-width: 481px) and (max-width: 768px) {
             .dialog-content {
                 max-width: 85vw !important;
                 max-height: 85vh !important;
             }
             
             .dialog-canvas-container {
                 min-height: 350px;
             }
             
             .dialog-canvas {
                 min-height: 300px;
             }
         }
         
         @media (min-width: 769px) {
             .dialog-content {
                 max-width: 70vw !important;
                 max-height: 80vh !important;
             }
             
             .dialog-canvas-container {
                 min-height: 400px;
             }
             
             .dialog-canvas {
                 min-height: 350px;
             }
         }
         
         /* Hide expand button on mobile */
         @media (max-width: 768px) {
             .expand-btn {
                 display: none;
             }
         }
         
        /* Show expand button on desktop */
        @media (min-width: 769px) {
            .canvas-container {
                justify-content: center;
                align-items: center;
            }
            
            #signatureCanvas {
                margin: 0 auto;
                display: block;
            }
            
            .expand-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 10;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
                font-size: 1rem;
                backdrop-filter: blur(10px);
            }
            
            .expand-btn:hover {
                background: linear-gradient(135deg, #0056b3, #004085);
                transform: scale(1.15);
                box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
            }
            
            .expand-btn:active {
                transform: scale(1.05);
            }
        }
        .canvas-controls {
            margin-top: 1rem;
            text-align: center;
        }
        .btn-client {
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .btn-client:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-client:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Enhanced button styles for all browsers and devices */
        #signBtn {
            position: relative;
            z-index: 10;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto !important;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* Enhanced touch target for tablets */
            min-height: 48px;
            min-width: 48px;
            /* Samsung Internet compatibility */
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
            -khtml-user-select: none;
            /* Better touch feedback */
            transition: all 0.2s ease;
        }
        
        #signBtn:not(:disabled) {
            cursor: pointer;
            pointer-events: auto !important;
        }
        
        #signBtn:not(:disabled):active {
            transform: scale(0.98);
            background-color: #1e7e34 !important;
        }
        
        #signBtn:disabled {
            cursor: not-allowed;
            pointer-events: none !important;
            opacity: 0.6;
        }
        
        /* Samsung Internet specific fixes */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            #signBtn {
                -webkit-appearance: none;
                appearance: none;
                border-radius: 10px;
            }
        }
        
        /* Modal fixes for Samsung Internet */
        .modal {
            z-index: 1055 !important;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }
        
        /* Samsung Internet modal compatibility */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            .modal {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
            
            .modal-dialog {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
        }
        
        /* Force hardware acceleration for modals */
        .modal.show {
            display: block !important;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        /* Samsung Internet specific modal backdrop */
        .modal-backdrop.fade.show {
            opacity: 0.5 !important;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        .logo-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .signature-instructions {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }
        .progress-indicator {
            background: #fff3cd;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #ffc107;
        }
        .btn-group-signature {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-group-signature .btn {
            flex: 1;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="client-container">
            <!-- Header -->
            <div class="client-header">
                <div class="logo-icon">
                    <i class="fas fa-pen-fancy"></i>
                </div>
                <h2 class="mb-2">Assinatura Digital</h2>
                <p class="mb-0">Desenhe sua assinatura no campo abaixo</p>
            </div>

            <!-- Body -->
            <div class="client-body">
                <!-- Informações do Documento -->
                <div class="document-info">
                    <h5 class="mb-3">
                        <i class="fas fa-file-pdf me-2 text-danger"></i>
                        Documento para Assinatura
                    </h5>
                    <div class="row">
                        <div class="col-md-8">
                            <strong>{{ signature.original_filename }}</strong>
                            <br>
                            <small class="text-muted">
                                Cliente: {{ signature.client_name }} | 
                                CPF: {{ signature.client_cpf|cpf }}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-warning">
                                <i class="fas fa-clock me-1"></i>Aguardando Assinatura
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Instruções -->
                <div class="signature-instructions">
                    <h6 class="mb-2">
                        <i class="fas fa-info-circle me-2"></i>
                        Instruções para Assinatura
                    </h6>
                    <ul class="mb-0">
                        <li>Use o dedo ou caneta para desenhar sua assinatura no campo abaixo</li>
                        <li>Certifique-se de que a assinatura esteja clara e legível</li>
                        <li>Você pode apagar e refazer quantas vezes quiser</li>
                        <li>Clique em "Finalizar Assinatura" quando estiver satisfeito</li>
                    </ul>
                </div>

                <!-- Área de Assinatura -->
                <div class="signature-area">
                    <h5 class="mb-3 text-center">
                        <i class="fas fa-signature me-2 text-primary"></i>
                        Sua Assinatura
                    </h5>
                    
                    <div class="canvas-container position-relative">
                        <canvas id="signatureCanvas" width="600" height="200"></canvas>
                        <button class="expand-btn" id="expandBtn" title="Expandir área de assinatura">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                    
                    <div class="canvas-controls">
                        <div class="btn-group-signature">
                            <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                                <i class="fas fa-eraser me-2"></i>Limpar
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="undoBtn">
                                <i class="fas fa-undo me-2"></i>Desfazer
                            </button>
                            <button type="button" class="btn btn-success" id="signBtn" disabled>
                                <i class="fas fa-check me-2"></i>Finalizar Assinatura
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Indicador de Progresso -->
                <div class="progress-indicator">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clipboard-check me-2 text-warning"></i>
                        <div class="flex-grow-1">
                            <strong>Etapa 3 de 3:</strong> Assinatura do Documento
                        </div>
                        <span class="badge bg-success">75%</span>
                    </div>
                </div>

                <!-- Botões de Navegação -->
                <div class="d-grid gap-2">
                    <a href="{{ url_for('client_confirm_document', signature_id=signature.id) }}" class="btn btn-outline-secondary btn-client">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Mobile Signature Dialog - DENTRO DO CONTAINER -->
        <div class="signature-dialog" id="signatureDialog">
            <div class="dialog-content">
                <div class="dialog-header">
                    <h5 class="dialog-title">
                        <i class="fas fa-signature"></i>
                        Desenhe sua Assinatura
                    </h5>
                    <button class="dialog-close" id="dialogCloseBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="dialog-canvas-container">
                    <canvas id="dialogCanvas" class="dialog-canvas"></canvas>
                </div>
                
                <div class="dialog-controls">
                    <div class="color-picker-group">
                        <span class="me-2 fw-bold">Cor:</span>
                        <div class="color-picker active" data-color="#000" style="background: #000;"></div>
                    </div>
                    
                    <div class="dialog-buttons">
                        <button class="dialog-btn dialog-btn-clear" id="dialogClearBtn">
                            <i class="fas fa-eraser"></i>Limpar
                        </button>
                        <button class="dialog-btn dialog-btn-undo" id="dialogUndoBtn">
                            <i class="fas fa-undo"></i>Desfazer
                        </button>
                        <button class="dialog-btn dialog-btn-done" id="dialogDoneBtn">
                            <i class="fas fa-check"></i>Concluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- HUDs: validação, confirmação, sucesso e erro -->
    <div class="modal fade" id="signValidationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-triangle-exclamation text-warning me-2"></i> Atenção</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="signValidationText" class="mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ok</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="signConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-question-circle text-primary me-2"></i> Confirmar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Tem certeza que deseja finalizar a assinatura? Esta ação não pode ser desfeita.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="signConfirmBtn"><i class="fas fa-check me-1"></i>Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="signSuccessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-check-circle text-success me-2"></i> Sucesso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="signSuccessText" class="mb-0"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="signErrorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-times-circle text-danger me-2"></i> Erro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="signErrorText" class="mb-0"></p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Configuração do canvas
        const DIALOG_ASPECT_LANDSCAPE = 3 / 1; // ex.: 3:1 no modo paisagem
        const DIALOG_ASPECT_PORTRAIT  = 4 / 3; // ex.: 4:3 no modo retrato
        const DPR = window.devicePixelRatio || 1;
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        const clearBtn = document.getElementById('clearBtn');
        const undoBtn = document.getElementById('undoBtn');
        const signBtn = document.getElementById('signBtn');
        console.log('signBtn encontrado:', signBtn);
        if (!signBtn) {
            console.error('signBtn não encontrado!');
        }
        
         // Dialog elements
         const expandBtn = document.getElementById('expandBtn');
         const signatureDialog = document.getElementById('signatureDialog');
         const dialogCanvas = document.getElementById('dialogCanvas');
         const dialogCtx = dialogCanvas.getContext('2d');
         const dialogCloseBtn = document.getElementById('dialogCloseBtn');
         const dialogClearBtn = document.getElementById('dialogClearBtn');
         const dialogUndoBtn = document.getElementById('dialogUndoBtn');
         const dialogDoneBtn = document.getElementById('dialogDoneBtn');
         
         let isDrawing = false;
         let hasSignature = false;
         let signatureHistory = [];
         let currentPath = [];
         
         // Dialog variables
         let dialogPaths = [];
         let dialogCurrentPath = [];
         let isDialogDrawing = false;
         let currentColor = '#000';
         
         // Tamanhos lógicos (CSS px) atuais de cada canvas
         let mainLogicalSize = { w: 600, h: 200 };
         let dialogLogicalSize = { w: 600, h: 200 };
        
        // Enhanced mobile/tablet detection for all browsers including Samsung Internet
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|SamsungBrowser|Samsung/i.test(navigator.userAgent);
        const isTablet = /iPad|Android(?!.*Mobile)|Tablet/i.test(navigator.userAgent) || 
                        (navigator.maxTouchPoints && navigator.maxTouchPoints > 1 && window.innerWidth >= 768);
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const isSamsungInternet = /SamsungBrowser|Samsung/i.test(navigator.userAgent);
        const devicePixelRatio = window.devicePixelRatio || 1; // Para high-DPI
        
        console.log('Device detection:', {
            isMobile,
            isTablet, 
            isTouchDevice,
            isSamsungInternet,
            userAgent: navigator.userAgent,
            maxTouchPoints: navigator.maxTouchPoints,
            devicePixelRatio,
            screenWidth: window.innerWidth
        });
        
        function fitCanvasHiDPI(canvasElement, context, cssWidth, cssHeight) {
            // Tamanho interno (físico)
            canvasElement.width  = Math.round(cssWidth * DPR);
            canvasElement.height = Math.round(cssHeight * DPR);
            // Tamanho visual (CSS)
            canvasElement.style.width  = cssWidth + 'px';
            canvasElement.style.height = cssHeight + 'px';
            // Reset e aplica transformação: desenhar em CSS pixels
            context.setTransform(DPR, 0, 0, DPR, 0, 0);
            }
        // Configurações do canvas (com suporte a high-DPI)
        function setupCanvasContext() {
            ctx.strokeStyle = '#000';
            ctx.lineWidth = isMobile ? 3 : 2; // em CSS px; não multiplique por DPR
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            }
        
        // Dialog canvas setup
        function setupDialogContext() {
            dialogCtx.strokeStyle = currentColor;
            dialogCtx.lineWidth = (isMobile ? 3 : 2); // em CSS px
            dialogCtx.lineCap = 'round';
            dialogCtx.lineJoin = 'round';
            }
        
        // Função precisa para obter coordenadas (corrige offset em mobile/high-DPI)
        function getPointerPos(e, canvasElement) {
            const rect = canvasElement.getBoundingClientRect();
            const touch = e.touches?.[0] || e.changedTouches?.[0] || e;
            const clientX = touch.clientX;
            const clientY = touch.clientY;
            // Retorna coordenadas em CSS pixels (sem aplicar DPR novamente)
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
            }
         
         // Responsive canvas sizing (com high-DPI)
         function resizeCanvas() {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth - 40;
            const logicalWidth = isMobile ? Math.min(containerWidth, 400) : Math.min(containerWidth, 600);
            const logicalHeight = 200;
            fitCanvasHiDPI(canvas, ctx, logicalWidth, logicalHeight);
            setupCanvasContext();
            
            // Atualiza tamanho lógico
            mainLogicalSize.w = logicalWidth;
            mainLogicalSize.h = logicalHeight;
            
            redrawCanvas();
            }
         
         // Dialog canvas setup (com high-DPI)
         function setupDialogCanvas() {
            const container = document.querySelector('.dialog-canvas-container');
            const styles = getComputedStyle(container);
            const paddingX = parseFloat(styles.paddingLeft) + parseFloat(styles.paddingRight);
            const paddingY = parseFloat(styles.paddingTop) + parseFloat(styles.paddingBottom);
            // Largura disponível (em CSS px)
            const containerWidth = container.clientWidth; // inclui padding
            const innerWidth = Math.max(300, Math.round(containerWidth - paddingX));
            // Define razão de aspecto conforme orientação
            const portrait = window.matchMedia('(orientation: portrait)').matches;
            const aspect = portrait ? DIALOG_ASPECT_PORTRAIT : DIALOG_ASPECT_LANDSCAPE;
            // Altura interna proporcional (em CSS px)
            let innerHeight = Math.round(innerWidth / aspect);
            // Limites de altura para não estourar o dialog
            // Você pode ajustar esses limites conforme seu layout
            const MIN_INNER_HEIGHT = 200;
            const MAX_INNER_HEIGHT = Math.round(window.innerHeight * 0.6);
            innerHeight = Math.max(MIN_INNER_HEIGHT, Math.min(innerHeight, MAX_INNER_HEIGHT));
            // Ajusta a altura do container para acompanhar o canvas (altura interna + paddings)
            container.style.height = (innerHeight + paddingY) + 'px';
            // Configura o canvas em HiDPI
            dialogCanvas.width  = Math.round(innerWidth * DPR);
            dialogCanvas.height = Math.round(innerHeight * DPR);
            dialogCanvas.style.width  = innerWidth + 'px';
            dialogCanvas.style.height = innerHeight + 'px';
            // Desenha em coordenadas de CSS px; DPR aplicado aqui
            dialogCtx.setTransform(DPR, 0, 0, DPR, 0, 0);
            setupDialogContext();
            
            // Atualiza tamanho lógico do dialog
            dialogLogicalSize.w = innerWidth;
            dialogLogicalSize.h = innerHeight;
            
            // Redesenha, se já tiver conteúdo
            if (typeof redrawDialogCanvas === 'function') {
                redrawDialogCanvas();
            }
        }

         
        
        // Reescala paths de um tamanho lógico para outro
        function scalePaths(srcPaths, fromW, fromH, toW, toH) {
            if (!srcPaths || !srcPaths.length) return [];
            const sx = toW / fromW;
            const sy = toH / fromH;
            return srcPaths.map(path => {
                // path pode ser array de pontos {x,y} ou {x,y,color}
                return path.map(p => ({
                    x: p.x * sx,
                    y: p.y * sy,
                    color: p.color || '#000'
                }));
            });
        }
        
        // Função para limpar canvas corretamente
        function clearCanvas(context, canvasElement) {
            context.save();
            context.setTransform(1, 0, 0, 1, 0, 0);
            context.clearRect(0, 0, canvasElement.width, canvasElement.height);
            context.restore();
        }
        
        // Função para coletar informações do dispositivo
        function collectDeviceInfo() {
            return {
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                userAgent: navigator.userAgent,
                cookieEnabled: navigator.cookieEnabled,
                onlineStatus: navigator.onLine
            };
        }
        
        // Mouse events (mantidos para desktop)
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events corrigidos (sem preventDefault excessivo)
        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) return; // Ignora multi-touch
            startDrawing(e);
        }, { passive: true }); // Passive para performance
        
        canvas.addEventListener('touchmove', throttledDraw, { passive: true });
        canvas.addEventListener('touchend', stopDrawing, { passive: true });
        
        // Pointer Events como fallback unificado (melhor compatibilidade)
        canvas.addEventListener('pointerdown', (e) => {
            if (e.pointerType === 'touch') {
                canvas.setPointerCapture(e.pointerId);
                startDrawing(e);
            }
        });
        canvas.addEventListener('pointermove', (e) => {
            if (e.pointerType === 'touch' && isDrawing) {
                draw(e);
            }
        });
        canvas.addEventListener('pointerup', (e) => {
            if (e.pointerType === 'touch') {
                stopDrawing(e);
            }
        });
        
        // Auto-open dialog on mobile/tablet touch - Enhanced for all browsers
        if (isMobile || isTablet || isTouchDevice) {
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                openSignatureDialog();
            }, { passive: false });
        }
        
        // Eventos unificados com Pointer Events (melhor para cross-device)
        function startDrawing(e) {
            e.preventDefault(); // Só no canvas, não propaga
            isDrawing = true;
            const coords = getPointerPos(e, canvas);
            currentPath = [{x: coords.x, y: coords.y}];
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const coords = getPointerPos(e, canvas);
            currentPath.push({x: coords.x, y: coords.y});
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }
        
        function stopDrawing(e) {
            if (isDrawing) {
                isDrawing = false;
                if (currentPath.length > 0) {
                    signatureHistory.push([...currentPath]);
                    currentPath = [];
                    hasSignature = true;
                    updateSignButton();
                }
            }
        }
        
        // Throttled touchmove para performance (evita lag em mobile)
        let lastTouchMove = 0;
        function throttledDraw(e) {
            const now = Date.now();
            if (now - lastTouchMove < 16) return; // ~60fps
            lastTouchMove = now;
            draw(e);
        }
        
        // Mesmas correções para o dialog canvas
        function startDialogDrawing(e) {
            e.preventDefault();
            isDialogDrawing = true;
            const coords = getPointerPos(e, dialogCanvas);
            dialogCurrentPath = [{ x: coords.x, y: coords.y, color: currentColor }];
            dialogPaths.push(dialogCurrentPath);
            dialogCtx.beginPath();
            dialogCtx.moveTo(coords.x, coords.y);
        }
        
        function drawDialog(e) {
            if (!isDialogDrawing) return;
            e.preventDefault();
            const coords = getPointerPos(e, dialogCanvas);
            dialogCurrentPath.push({ x: coords.x, y: coords.y, color: currentColor });
            redrawDialogCanvas();
        }
        
        function stopDialogDrawing() {
            isDialogDrawing = false;
            dialogCurrentPath = [];
        }
        
        let lastDialogTouchMove = 0;
        function throttledDrawDialog(e) {
            const now = Date.now();
            if (now - lastDialogTouchMove < 16) return;
            lastDialogTouchMove = now;
            drawDialog(e);
        }
        
        // Botão Limpar
        clearBtn.addEventListener('click', function() {
            clearCanvas(ctx, canvas);
            signatureHistory = [];
            hasSignature = false;
            updateSignButton();
        });
        
        // Botão Desfazer
        undoBtn.addEventListener('click', function() {
            if (signatureHistory.length > 0) {
                signatureHistory.pop();
                redrawCanvas();
                hasSignature = signatureHistory.length > 0;
                updateSignButton();
            }
        });
        
        // Função para redesenhar o canvas
        function redrawCanvas() {
            clearCanvas(ctx, canvas);
            setupCanvasContext(); // garante lineWidth/estilos
            
            signatureHistory.forEach(path => {
                if (path.length > 0) {
                    ctx.strokeStyle = path[0].color || '#000';
                    ctx.beginPath();
                    ctx.moveTo(path[0].x, path[0].y);
                    for (let i = 1; i < path.length; i++) {
                        ctx.lineTo(path[i].x, path[i].y);
                    }
                    ctx.stroke();
                }
            });
        }
        
        function redrawDialogCanvas() {
            clearCanvas(dialogCtx, dialogCanvas);
            setupDialogContext();
            
            dialogPaths.forEach(path => {
                if (path.length > 0) {
                    dialogCtx.strokeStyle = path[0].color || currentColor || '#000';
                    dialogCtx.beginPath();
                    dialogCtx.moveTo(path[0].x, path[0].y);
                    for (let i = 1; i < path.length; i++) {
                        dialogCtx.lineTo(path[i].x, path[i].y);
                    }
                    dialogCtx.stroke();
                }
            });
        }
        
        // Função para atualizar estado do botão de assinatura
        function updateSignButton() {
            if (signBtn) {
                signBtn.disabled = !hasSignature;
                console.log('Botão assinatura:', hasSignature ? 'Habilitado' : 'Desabilitado');
                console.log('signBtn.disabled:', signBtn.disabled);
            } else {
                console.error('signBtn não encontrado em updateSignButton!');
            }
        }
        
         // Dialog functions with animations
         function openSignatureDialog() {
             // Prevent body scroll and add class
             document.body.style.overflow = 'hidden';
             document.body.classList.add('dialog-open');
             
             // Add active class for animation
             signatureDialog.classList.add('active');
             
             // Setup canvas after animation starts with delay for proper rendering
             setTimeout(() => {
                 setupDialogCanvas();
                 copyCanvasToDialog();
             }, 100); // Increased delay for better rendering
         }
         
         function closeSignatureDialog() {
             signatureDialog.classList.remove('active');
             
             // Wait for animation to complete before hiding
             setTimeout(() => {
                 // Restore body scroll and remove class
                 document.body.style.overflow = '';
                 document.body.classList.remove('dialog-open');
             }, 400); // Match animation duration
         }
         
        // Desktop expand button (only visible on desktop)
        if (!isMobile && !isTablet) {
            expandBtn.addEventListener('click', () => {
                openSignatureDialog();
            });
        }
         
         // Dialog close buttons
         dialogCloseBtn.addEventListener('click', closeSignatureDialog);
         dialogDoneBtn.addEventListener('click', () => {
             copyDialogToCanvas();
             closeSignatureDialog();
         });
         
         // Close dialog when clicking on background
         signatureDialog.addEventListener('click', (e) => {
             if (e.target === signatureDialog) {
                 closeSignatureDialog();
             }
         });
         
         // Prevent dialog content clicks from closing dialog
         document.querySelector('.dialog-content').addEventListener('click', (e) => {
             e.stopPropagation();
         });
         
         // Copia o conteúdo da página para o dialog (reescalando paths)
         function copyCanvasToDialog() {
             // Converte histórico da página (main) para o tamanho do dialog
             dialogPaths = scalePaths(
                 signatureHistory,
                 mainLogicalSize.w, mainLogicalSize.h,
                 dialogLogicalSize.w, dialogLogicalSize.h
             );
             // Redesenha no dialog
             redrawDialogCanvas();
         }
         
         // Copia o conteúdo do dialog para a página (reescalando paths)
         function copyDialogToCanvas() {
             // Converte histórico do dialog para o tamanho da página
             signatureHistory = scalePaths(
                 dialogPaths,
                 dialogLogicalSize.w, dialogLogicalSize.h,
                 mainLogicalSize.w, mainLogicalSize.h
             );
             // Redesenha na página
             redrawCanvas();
             hasSignature = signatureHistory.length > 0;
             updateSignButton();
         }
         
         // Dialog mouse events
         dialogCanvas.addEventListener('mousedown', startDialogDrawing);
         dialogCanvas.addEventListener('mousemove', drawDialog);
         dialogCanvas.addEventListener('mouseup', stopDialogDrawing);
         dialogCanvas.addEventListener('mouseout', stopDialogDrawing);
         
         // Dialog touch events
         dialogCanvas.addEventListener('touchstart', (e) => {
             if (e.touches.length > 1) return;
             startDialogDrawing(e);
         }, { passive: true });
         
         dialogCanvas.addEventListener('touchmove', throttledDrawDialog, { passive: true });
         dialogCanvas.addEventListener('touchend', stopDialogDrawing, { passive: true });
         
         // Dialog pointer events
         dialogCanvas.addEventListener('pointerdown', (e) => {
             if (e.pointerType === 'touch') {
                 dialogCanvas.setPointerCapture(e.pointerId);
                 startDialogDrawing(e);
             }
         });
         dialogCanvas.addEventListener('pointermove', (e) => {
             if (e.pointerType === 'touch' && isDialogDrawing) {
                 drawDialog(e);
             }
         });
         dialogCanvas.addEventListener('pointerup', (e) => {
             if (e.pointerType === 'touch') {
                 stopDialogDrawing(e);
             }
         });
         
        // Dialog controls
        dialogClearBtn.addEventListener('click', () => {
            clearCanvas(dialogCtx, dialogCanvas);
            dialogPaths = [];
        });
        
        dialogUndoBtn.addEventListener('click', () => {
            if (dialogPaths.length > 0) {
                dialogPaths.pop();
                redrawDialogCanvas();
            }
        });
        
        // Color picker for dialog
        document.querySelectorAll('.color-picker').forEach(picker => {
            picker.addEventListener('click', function() {
                document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                currentColor = this.dataset.color;
                dialogCtx.strokeStyle = currentColor;
            });
        });
         
        
        // Enhanced Finalizar Assinatura button with Pointer Events
        console.log('Configurando event listener para signBtn:', signBtn);
        if (signBtn) {
            // Handler unificado com Pointer Events (melhor compatibilidade)
            const handleSignClick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Botão clicado! hasSignature:', hasSignature);
                console.log('Event type:', e.type, 'Pointer type:', e.pointerType);
                console.log('Botão disabled:', signBtn.disabled);
            
            if (!hasSignature) {
                console.log('Sem assinatura, mostrando modal de validação');
                // HUD de validação com fallback para Samsung Internet
                document.getElementById('signValidationText').textContent = 'Por favor, desenhe sua assinatura antes de continuar.';
                showModalWithFallback('signValidationModal');
                return;
            }

            // Mostra HUD de confirmação com fallback
            showModalWithFallback('signConfirmModal');

            const doSign = () => {
                // Fecha modal de confirmação
                const confirmModalEl = document.getElementById('signConfirmModal');
                if (confirmModalEl) {
                    confirmModalEl.style.display = 'none';
                    confirmModalEl.classList.remove('show');
                    const backdrop = document.getElementById('modal-backdrop-signConfirmModal');
                    if (backdrop) backdrop.remove();
                    document.body.style.overflow = '';
                }
                document.getElementById('signConfirmBtn').removeEventListener('click', doSign);

                // Desabilita botão para evitar duplo envio
                signBtn.disabled = true;
                signBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
                
                // Converte canvas para base64
                const signatureData = canvas.toDataURL('image/png');
                
                // Coleta informações do dispositivo
                const deviceInfo = collectDeviceInfo();
                
                // Envia assinatura para o servidor
                fetch("{{ url_for('client_sign_document', signature_id=signature.id) }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Screen-Resolution': deviceInfo.screenResolution,
                        'X-Timezone': deviceInfo.timezone
                    },
                    body: JSON.stringify({
                        signature_image: signatureData,
                        device_info: deviceInfo
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // HUD de sucesso
                        document.getElementById('signSuccessText').textContent = 'Assinatura realizada com sucesso!';
                        showModalWithFallback('signSuccessModal');
                        setTimeout(() => { window.location.href = data.redirect; }, 800);
                    } else {
                        // HUD de erro
                        document.getElementById('signErrorText').textContent = 'Erro ao processar assinatura: ' + (data.message || 'Tente novamente.');
                        showModalWithFallback('signErrorModal');
                        signBtn.disabled = false;
                        signBtn.innerHTML = '<i class="fas fa-check me-2"></i>Finalizar Assinatura';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    document.getElementById('signErrorText').textContent = 'Erro ao processar assinatura. Tente novamente.';
                    showModalWithFallback('signErrorModal');
                    signBtn.disabled = false;
                    signBtn.innerHTML = '<i class="fas fa-check me-2"></i>Finalizar Assinatura';
                });
            };
            document.getElementById('signConfirmBtn').addEventListener('click', doSign);
            };
            
            // Pointer Events como handler principal (melhor compatibilidade cross-device)
            signBtn.addEventListener('pointerup', handleSignClick);
            
            // Fallback para browsers antigos
            signBtn.addEventListener('click', handleSignClick);
            
            // Touch fallback específico para Samsung Internet
            if (navigator.userAgent.includes('SamsungBrowser')) {
                signBtn.addEventListener('touchend', handleSignClick);
            }
            
        } else {
            console.error('signBtn não encontrado, não é possível configurar event listener!');
        }
        
        // Função de fallback para modais (Samsung Internet compatibility)
        function showModalWithFallback(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) {
                console.error('Modal não encontrado:', modalId);
                return;
            }
            
            // Para Samsung Internet, usa fallback direto
            if (isSamsungInternet) {
                console.log('Samsung Internet detectado, usando fallback direto');
                showModalFallback(modalElement, modalId);
                return;
            }
            
            try {
                // Tenta usar Bootstrap Modal primeiro
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log('Modal Bootstrap exibido:', modalId);
            } catch (error) {
                console.warn('Bootstrap Modal falhou, usando fallback:', error);
                showModalFallback(modalElement, modalId);
            }
        }
        
        function showModalFallback(modalElement, modalId) {
            // Fallback: exibe modal manualmente
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            modalElement.setAttribute('aria-modal', 'true');
            modalElement.setAttribute('role', 'dialog');
            
            // Adiciona backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'modal-backdrop-' + modalId;
            document.body.appendChild(backdrop);
            
            // Previne scroll do body
            document.body.style.overflow = 'hidden';
            
            // Adiciona listener para fechar modal
            const closeModal = () => {
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.removeAttribute('aria-modal');
                modalElement.removeAttribute('role');
                
                const backdropEl = document.getElementById('modal-backdrop-' + modalId);
                if (backdropEl) {
                    backdropEl.remove();
                }
                
                document.body.style.overflow = '';
            };
            
            // Fecha modal ao clicar no backdrop
            modalElement.addEventListener('click', (e) => {
                if (e.target === modalElement) {
                    closeModal();
                }
            });
            
            // Fecha modal ao clicar no X
            const closeBtn = modalElement.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            // Fecha modal ao pressionar ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            console.log('Modal fallback exibido:', modalId);
        }
        
        // Enhanced initialization
        updateSignButton();
        
        // Initialize canvas on load
        window.addEventListener('load', () => {
            resizeCanvas();
            setupDialogCanvas();
        });
        
        // Resize with debouncing
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                resizeCanvas();
                if (signatureDialog.classList.contains('active')) {
                    setupDialogCanvas();
                    setTimeout(() => redrawDialogCanvas(), 100);
                }
            }, 150);
        });
        
        // Previne zoom em dispositivos móveis
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
