<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desenhar Assinatura - Assinador Digital</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- User Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-signature me-2"></i>Assinador Digital
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>{{ current_user.full_name }}
                    {% if current_user.is_admin() %}
                        <span class="badge bg-warning ms-2">Admin</span>
                    {% endif %}
                </span>
                <a class="nav-link" href="{{ url_for('validate_pdf') }}">
                    <i class="fas fa-shield-alt me-1"></i>Validador
                </a>
                <a class="nav-link" href="{{ url_for('profile') }}">
                    <i class="fas fa-user-circle me-1"></i>Perfil
                </a>
                {% if current_user.is_admin() %}
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                    <i class="fas fa-cog me-1"></i>Admin
                </a>
                {% endif %}
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Sair
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Progress Steps -->
        <div class="signature-step-indicator text-center">
            <div class="signature-step completed">1</div>
            <div class="signature-step completed">2</div>
            <div class="signature-step completed">3</div>
            <div class="signature-step active">4</div>
            <div class="signature-step">5</div>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-pen-nib me-2"></i>
                            Etapa 4: Desenhar Assinatura
                        </h4>
                        <small>Desenhe sua assinatura na área abaixo</small>
                    </div>
                    <div class="card-body p-4">
                        
                        <!-- Toolbar -->
                        <div class="signature-toolbar">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-2">Cor da Caneta:</h6>
                                    <div class="d-flex">
                                        <div class="signature-color-picker active" style="background: #000;" data-color="#000" title="Preto"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="mb-2">Espessura:</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="signature-brush-size" style="width: 20px; height: 20px;" data-size="2" title="Fino"></div>
                                        <div class="signature-brush-size active" style="width: 25px; height: 25px;" data-size="3" title="Médio"></div>
                                        <div class="signature-brush-size" style="width: 30px; height: 30px;" data-size="4" title="Grosso"></div>
                                        <div class="signature-brush-size" style="width: 35px; height: 35px;" data-size="6" title="Extra Grosso"></div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                                        <i class="fas fa-eraser me-2"></i>Limpar
                                    </button>
                                    <button type="button" class="btn btn-outline-info" id="undoBtn">
                                        <i class="fas fa-undo me-2"></i>Desfazer
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Canvas Area -->
                        <div class="signature-canvas-container">
                            <div class="text-center mb-3">
                                <h6 class="text-muted">
                                    <i class="fas fa-hand-pointer me-2"></i>
                                    Desenhe sua assinatura na área abaixo
                                </h6>
                                <small class="text-muted">
                                    Use o mouse ou toque na tela para desenhar. A assinatura será redimensionada automaticamente.
                                </small>
                            </div>
                            
                            <div class="d-flex justify-content-center position-relative">
                                <canvas id="signatureCanvas" class="signature-signature-canvas" width="600" height="200"></canvas>
                                <button class="signature-expand-btn" id="expandBtn" title="Expandir tela">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-mobile-alt me-1"></i>
                                    Funciona em dispositivos móveis e desktop
                                </small>
                            </div>
                        </div>

                        <!-- Preview -->
                        <div class="signature-preview hidden-element" id="signaturePreview">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-eye me-2"></i>Prévia da Assinatura:
                            </h6>
                            <div class="text-center">
                                <img id="previewImage" alt="Preview da assinatura" class="preview-image">
                            </div>
                        </div>
                        
                        <!-- Fullscreen Mode -->
                        <div class="signature-fullscreen-mode" id="fullscreenMode">
                            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                                <h5 class="mb-0">
                                    <i class="fas fa-expand-arrows-alt me-2"></i>
                                    Modo Tela Cheia
                                </h5>
                                <button class="btn btn-outline-secondary" id="exitFullscreenBtn">
                                    <i class="fas fa-times me-2"></i>Sair
                                </button>
                            </div>
                            
                            <div class="p-3">
                                <canvas id="fullscreenCanvas" class="signature-fullscreen-canvas"></canvas>
                            </div>
                            
                            <div class="signature-fullscreen-controls">
                                <div class="row align-items-center">
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <span class="me-3">Cor:</span>
                                            <div class="signature-color-picker" data-color="#000" style="background: #000;"></div>
                                        </div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <button class="btn btn-outline-danger me-2" id="fullscreenClearBtn">
                                            <i class="fas fa-eraser me-1"></i>Limpar
                                        </button>
                                        <button class="btn btn-outline-info me-2" id="fullscreenUndoBtn">
                                            <i class="fas fa-undo me-1"></i>Desfazer
                                        </button>
                                        <button class="btn btn-success" id="fullscreenDoneBtn">
                                            <i class="fas fa-check me-1"></i>Concluir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <a href="{{ url_for('signature_pending') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Voltar à Revisão
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-info me-2" id="previewBtn" disabled>
                                    <i class="fas fa-eye me-2"></i>Visualizar
                                </button>
                                <button type="button" class="btn btn-success btn-lg" id="signBtn" disabled>
                                    <i class="fas fa-file-signature me-2"></i>
                                    Finalizar Assinatura
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dicas -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-lightbulb me-2 text-warning"></i>
                            Dicas para uma Boa Assinatura
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-check text-success me-2"></i>Desenhe de forma natural, como em papel</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Use movimentos fluidos e contínuos</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Mantenha a assinatura dentro da área</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-info-circle text-info me-2"></i>A assinatura será redimensionada automaticamente</li>
                                    <li><i class="fas fa-info-circle text-info me-2"></i>Você pode limpar e refazer quantas vezes quiser</li>
                                    <li><i class="fas fa-info-circle text-info me-2"></i>Use a espessura que for mais confortável</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script nonce="{{ csp_nonce() }}" src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script nonce="{{ csp_nonce() }}">
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        const clearBtn = document.getElementById('clearBtn');
        const undoBtn = document.getElementById('undoBtn');
        const previewBtn = document.getElementById('previewBtn');
        const signBtn = document.getElementById('signBtn');
        const previewDiv = document.getElementById('signaturePreview');
        const previewImage = document.getElementById('previewImage');
        
        // Fullscreen elements
        const expandBtn = document.getElementById('expandBtn');
        const fullscreenMode = document.getElementById('fullscreenMode');
        const fullscreenCanvas = document.getElementById('fullscreenCanvas');
        const fullscreenCtx = fullscreenCanvas.getContext('2d');
        const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
        const fullscreenClearBtn = document.getElementById('fullscreenClearBtn');
        const fullscreenUndoBtn = document.getElementById('fullscreenUndoBtn');
        const fullscreenDoneBtn = document.getElementById('fullscreenDoneBtn');

        let isDrawing = false;
        let currentPath = [];
        let allPaths = [];
        let currentColor = '#000';
        let currentSize = 3;
        
        // Fullscreen variables
        let fullscreenPaths = [];
        let fullscreenCurrentPath = [];
        let isFullscreenDrawing = false;

        // Canvas setup
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        fullscreenCtx.lineCap = 'round';
        fullscreenCtx.lineJoin = 'round';
        
        // Mobile detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Responsive canvas sizing
        function resizeCanvas() {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth - 40; // padding
            
            if (isMobile) {
                canvas.width = Math.min(containerWidth, 400);
                canvas.height = 200;
            } else {
                canvas.width = Math.min(containerWidth, 600);
                canvas.height = 200;
            }
            
            // Redraw existing paths
            redrawCanvas();
        }
        
        // Fullscreen canvas setup
        function setupFullscreenCanvas() {
            fullscreenCanvas.width = window.innerWidth;
            fullscreenCanvas.height = window.innerHeight - 120; // space for controls
        }
        
        // Initialize canvas on load
        window.addEventListener('load', () => {
            resizeCanvas();
            setupFullscreenCanvas();
        });
        
        // Resize on window resize
        window.addEventListener('resize', () => {
            resizeCanvas();
            if (fullscreenMode.classList.contains('active')) {
                setupFullscreenCanvas();
            }
        });

        // Color picker
        document.querySelectorAll('.color-picker').forEach(picker => {
            picker.addEventListener('click', function() {
                document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                currentColor = this.dataset.color;
            });
        });
        
        // Fullscreen mode functions
        expandBtn.addEventListener('click', () => {
            fullscreenMode.classList.add('active');
            document.body.style.overflow = 'hidden';
            setupFullscreenCanvas();
            copyCanvasToFullscreen();
        });
        
        exitFullscreenBtn.addEventListener('click', () => {
            fullscreenMode.classList.remove('active');
            document.body.style.overflow = '';
            copyFullscreenToCanvas();
        });
        
        fullscreenDoneBtn.addEventListener('click', () => {
            fullscreenMode.classList.remove('active');
            document.body.style.overflow = '';
            copyFullscreenToCanvas();
        });
        
        // Copy canvas content to fullscreen
        function copyCanvasToFullscreen() {
            fullscreenCtx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
            fullscreenCtx.drawImage(canvas, 0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
            fullscreenPaths = [...allPaths];
        }
        
        // Copy fullscreen content back to canvas
        function copyFullscreenToCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(fullscreenCanvas, 0, 0, canvas.width, canvas.height);
            allPaths = [...fullscreenPaths];
            updateButtons();
        }
        
        // Fullscreen drawing events
        fullscreenCanvas.addEventListener('mousedown', startFullscreenDrawing);
        fullscreenCanvas.addEventListener('mousemove', drawFullscreen);
        fullscreenCanvas.addEventListener('mouseup', stopFullscreenDrawing);
        fullscreenCanvas.addEventListener('mouseout', stopFullscreenDrawing);
        
        // Touch events for fullscreen
        fullscreenCanvas.addEventListener('touchstart', handleFullscreenTouch, { passive: false });
        fullscreenCanvas.addEventListener('touchmove', handleFullscreenTouch, { passive: false });
        fullscreenCanvas.addEventListener('touchend', stopFullscreenDrawing);
        
        function startFullscreenDrawing(e) {
            isFullscreenDrawing = true;
            const rect = fullscreenCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            fullscreenCurrentPath = [{ x, y, color: currentColor, size: currentSize }];
            fullscreenPaths.push(fullscreenCurrentPath);
        }
        
        function drawFullscreen(e) {
            if (!isFullscreenDrawing) return;
            
            const rect = fullscreenCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            fullscreenCurrentPath.push({ x, y, color: currentColor, size: currentSize });
            redrawFullscreenCanvas();
        }
        
        function stopFullscreenDrawing() {
            isFullscreenDrawing = false;
            fullscreenCurrentPath = [];
        }
        
        function handleFullscreenTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            fullscreenCanvas.dispatchEvent(mouseEvent);
        }
        
        function redrawFullscreenCanvas() {
            fullscreenCtx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
            
            fullscreenPaths.forEach(path => {
                if (path.length > 1) {
                    fullscreenCtx.strokeStyle = path[0].color;
                    fullscreenCtx.lineWidth = path[0].size;
                    fullscreenCtx.beginPath();
                    fullscreenCtx.moveTo(path[0].x, path[0].y);
                    
                    for (let i = 1; i < path.length; i++) {
                        fullscreenCtx.lineTo(path[i].x, path[i].y);
                    }
                    fullscreenCtx.stroke();
                }
            });
        }
        
        // Fullscreen controls
        fullscreenClearBtn.addEventListener('click', () => {
            fullscreenCtx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
            fullscreenPaths = [];
        });
        
        fullscreenUndoBtn.addEventListener('click', () => {
            if (fullscreenPaths.length > 0) {
                fullscreenPaths.pop();
                redrawFullscreenCanvas();
            }
        });

        // Brush size picker
        document.querySelectorAll('.brush-size').forEach(brush => {
            brush.addEventListener('click', function() {
                document.querySelectorAll('.brush-size').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentSize = parseInt(this.dataset.size);
            });
        });

        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            canvas.classList.add('signing');
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            currentPath = [{x, y, color: currentColor, size: currentSize}];
            
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            currentPath.push({x, y, color: currentColor, size: currentSize});
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                canvas.classList.remove('signing');
                allPaths.push([...currentPath]);
                currentPath = [];
                updateButtons();
            }
        }

        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events with improved mobile support
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        
        // Prevent scrolling on mobile when drawing
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        // Clear canvas
        clearBtn.addEventListener('click', function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            allPaths = [];
            previewDiv.style.display = 'none';
            updateButtons();
        });

        // Undo last stroke
        undoBtn.addEventListener('click', function() {
            if (allPaths.length > 0) {
                allPaths.pop();
                redrawCanvas();
                updateButtons();
            }
        });

        // Redraw canvas
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            allPaths.forEach(path => {
                if (path.length > 0) {
                    ctx.strokeStyle = path[0].color;
                    ctx.lineWidth = path[0].size;
                    ctx.beginPath();
                    ctx.moveTo(path[0].x, path[0].y);
                    
                    for (let i = 1; i < path.length; i++) {
                        ctx.lineTo(path[i].x, path[i].y);
                    }
                    ctx.stroke();
                }
            });
        }

        // Update button states
        function updateButtons() {
            const hasSignature = allPaths.length > 0;
            previewBtn.disabled = !hasSignature;
            signBtn.disabled = !hasSignature;
            undoBtn.disabled = allPaths.length === 0;
        }

        // Preview signature
        previewBtn.addEventListener('click', function() {
            if (allPaths.length > 0) {
                const dataURL = canvas.toDataURL('image/png');
                previewImage.src = dataURL;
                previewDiv.style.display = 'block';
                previewDiv.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Finalize signature
        signBtn.addEventListener('click', function() {
            if (allPaths.length === 0) {
                alert('Por favor, desenhe sua assinatura antes de continuar.');
                return;
            }

            const signatureData = canvas.toDataURL('image/png');
            
            // Disable button and show loading
            signBtn.disabled = true;
            signBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
            
            // Coleta informações do dispositivo
            const deviceInfo = collectDeviceInfo();
            
            // Send signature to server
            fetch("{{ url_for('signature_draw') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    'X-Screen-Resolution': deviceInfo.screenResolution,
                    'X-Timezone': deviceInfo.timezone,
                    'X-MAC-Address': deviceInfo.macAddress
                },
                body: JSON.stringify({
                    signature_image: signatureData,
                    device_info: deviceInfo
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Redirect to processing
                    window.location.href = "{{ url_for('signature_process') }}";
                } else {
                    alert('Erro ao salvar assinatura: ' + (data.message || 'Erro desconhecido'));
                    signBtn.disabled = false;
                    signBtn.innerHTML = '<i class="fas fa-file-signature me-2"></i>Finalizar Assinatura';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro de conexão: ' + error.message + '. Tente novamente.');
                signBtn.disabled = false;
                signBtn.innerHTML = '<i class="fas fa-file-signature me-2"></i>Finalizar Assinatura';
            });
        });

        // Initialize
        updateButtons();
        
        // Function to collect device information
        function collectDeviceInfo() {
            const info = {
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                macAddress: null,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onlineStatus: navigator.onLine
            };
            
            // Tentativa de obter informações de rede (limitado por segurança)
            try {
                // Esta API está sendo depreciada e pode não funcionar em todos os browsers
                if ('connection' in navigator) {
                    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                    if (connection) {
                        info.connectionType = connection.effectiveType;
                        info.downlink = connection.downlink;
                    }
                }
            } catch (e) {
                console.log('Não foi possível obter informações de conexão:', e);
            }
            
            // Tentativa de obter MAC address (muito limitado por questões de segurança)
            // Nota: Isso é extremamente limitado nos navegadores modernos por questões de privacidade
            try {
                if ('bluetooth' in navigator) {
                    // Esta é uma tentativa muito experimental e pode não funcionar
                    info.bluetoothSupported = true;
                }
            } catch (e) {
                info.bluetoothSupported = false;
            }
            
            return info;
        }

        // Prevent scrolling on touch devices when drawing
        document.body.addEventListener('touchstart', function(e) {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });

        document.body.addEventListener('touchend', function(e) {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });

        document.body.addEventListener('touchmove', function(e) {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
